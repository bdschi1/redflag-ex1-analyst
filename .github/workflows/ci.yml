name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          # Install main deps (but skip streamlit for faster CI)
          pip install pandas python-dotenv pdfplumber python-docx fpdf2

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --tb=short --cov=. --cov-report=term-missing --cov-config=pyproject.toml

      - name: Run CLI smoke test
        run: |
          echo "Testing CLI with sample files..."
          python run_redflag.py --input analyst_note.txt || EXIT_CODE=$?
          EXIT_CODE=${EXIT_CODE:-0}
          echo "Exit code: $EXIT_CODE"
          # Exit codes 0 (PASS), 10 (PM_REVIEW), 20 (AUTO_REJECT) are valid
          if [ "$EXIT_CODE" -ne 0 ] && [ "$EXIT_CODE" -ne 10 ] && [ "$EXIT_CODE" -ne 20 ]; then
            echo "FAIL: unexpected exit code $EXIT_CODE"
            exit 1
          fi
          echo "CLI smoke test passed (exit $EXIT_CODE)"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Ruff check
        run: ruff check redflag_engine.py run_redflag.py document_loader.py boilerplate_filter.py tests/

      - name: Ruff format check
        run: ruff format --check redflag_engine.py run_redflag.py document_loader.py boilerplate_filter.py tests/

  integration:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas python-dotenv pdfplumber python-docx

      - name: Test all example files
        run: |
          echo "=== Testing examples ==="
          for f in examples/*.txt; do
            echo "--- $f ---"
            python run_redflag.py --input "$f" --pretty | head -20
          done

      - name: Test all use cases
        run: |
          echo "=== Testing use_cases ==="
          for f in use_cases/*.txt; do
            echo "--- $f ---"
            python run_redflag.py --input "$f" --pretty | head -15
          done

      - name: Test all failure cases
        run: |
          echo "=== Testing failure_cases ==="
          for f in failure_cases/*.txt; do
            echo "--- $f ---"
            python run_redflag.py --input "$f" --pretty | head -15
          done

      - name: Verify exit codes
        run: |
          echo "=== Verifying exit codes ==="

          # Clean file should be PASS (0) or PM_REVIEW (10)
          python run_redflag.py --input examples/analyst_note_clean.txt > /dev/null || EXIT_CODE=$?
          EXIT_CODE=${EXIT_CODE:-0}
          if [ $EXIT_CODE -gt 10 ]; then
            echo "FAIL: Clean note should not AUTO_REJECT"
            exit 1
          fi
          echo "Clean note: exit $EXIT_CODE (OK)"

          # Risky file should be AUTO_REJECT (20)
          EXIT_CODE=0
          python run_redflag.py --input examples/analyst_note_risky.txt > /dev/null || EXIT_CODE=$?
          EXIT_CODE=${EXIT_CODE:-0}
          if [ $EXIT_CODE -ne 20 ]; then
            echo "FAIL: Risky note should AUTO_REJECT (exit 20), got $EXIT_CODE"
            exit 1
          fi
          echo "Risky note: exit $EXIT_CODE (OK)"

          # Test --no-filter flag works
          EXIT_CODE=0
          python run_redflag.py --input examples/analyst_note_risky.txt --no-filter > /dev/null || EXIT_CODE=$?
          EXIT_CODE=${EXIT_CODE:-0}
          if [ $EXIT_CODE -ne 20 ]; then
            echo "FAIL: Risky note with --no-filter should AUTO_REJECT (exit 20), got $EXIT_CODE"
            exit 1
          fi
          echo "Risky note (--no-filter): exit $EXIT_CODE (OK)"

          echo "All exit code tests passed!"
